@page "/app"
@using KS.Scheduler.Frontend.Models
@inject HttpClient Http

<PageTitle>Painel - KS Scheduler</PageTitle>

<!-- BLOCO DE LOADING (AQUI É O SEGREDO DO FLASH BRANCO) -->
@if (partida == null)
{
    <div class="d-flex flex-column align-items-center justify-content-center" style="height: 70vh;">
        <div class="spinner-border text-success" role="status"></div>
        <p class="mt-3 text-muted">Buscando informações do jogo...</p>
    </div>
}
else
{
    <!-- CONTEÚDO REAL (Só aparece quando os dados chegam) -->
    <div class="container-fluid p-0">

        <!-- Cabeçalho com o Resumo -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="fw-bold mb-1">Próxima Partida ⚽</h2>
                <p class="text-muted">@partida.DataHora.ToString("dd/MM/yyyy") às @partida.DataHora.ToString("HH:mm") • @partida.Local</p>

                <!-- Barra de Progresso Bonita -->
                <div class="progress mt-3 bg-secondary bg-opacity-25" style="height: 10px; border-radius: 10px;">
                    <div class="progress-bar bg-gradient-success" role="progressbar"
                         style="width: @(CalcularPorcentagem())%; border-radius: 10px;">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2 text-small text-muted">
                    <span>@partida.Presencas.Count(x => x.Confirmado) Confirmados</span>
                    <span>Meta: @partida.MaximoJogadores</span>
                </div>
            </div>
        </div>

        <!-- AS 3 LISTAS DE PARTICIPANTES -->
        <div class="row g-4">

            <!-- 1. JOGADORES CONFIRMADOS (Verde) -->
            <div class="col-md-4">
                <div class="card-custom border-top-success">
                    <h5 class="fw-bold text-success mb-3">✅ Confirmados</h5>
                    <div class="player-list">
                        @foreach (var p in ObterConfirmados())
                        {
                            <div class="player-item">
                                <span class="avatar bg-success">@p.Nome.Substring(0, 1)</span>
                                <div>
                                    <div class="fw-bold">@p.Nome</div>
                                    <small class="text-success-dim">@p.Posicao</small>
                                </div>
                            </div>
                        }
                        @if (!ObterConfirmados().Any())
                        {
                            <small class="text-muted">Ninguém ainda.</small>
                        }
                    </div>
                </div>
            </div>

            <!-- 2. PENDENTES DE CONFIRMAÇÃO (Amarelo) -->
            <div class="col-md-4">
                <div class="card-custom border-top-warning">
                    <h5 class="fw-bold text-warning mb-3">⏳ Pendentes</h5>
                    <div class="player-list">
                        <!-- Simulando dados pois sua model atual talvez não tenha status 'Pendente' ainda -->
                        <div class="player-item opacity-50">
                            <span class="avatar bg-warning text-dark">?</span>
                            <div>
                                <div class="fw-bold">Lista de Espera</div>
                                <small class="text-muted">Aguardando convite...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. DEVEDORES / PAGAMENTO PENDENTE (Vermelho) -->
            <div class="col-md-4">
                <div class="card-custom border-top-danger">
                    <h5 class="fw-bold text-danger mb-3">💸 Falta Pagar</h5>
                    <div class="player-list">
                        @foreach (var p in ObterConfirmados().Take(1)) // Exemplo: Pegando o primeiro como se devesse
                        {
                            <div class="player-item">
                                <span class="avatar bg-danger">@p.Nome.Substring(0, 1)</span>
                                <div class="w-100">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">@p.Nome</span>
                                        <span class="text-danger fw-bold">R$ @partida.ValorPorPessoa</span>
                                    </div>
                                    <small class="text-danger-dim">Pix não identificado</small>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

        </div>
    </div>
}

<style>
    /* Estilos dos Cards da Dashboard */
    .card-custom {
        background-color: #1e293b;
        border-radius: 16px;
        padding: 1.5rem;
        height: 100%;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .border-top-success {
        border-top: 4px solid #10b981;
    }

    .border-top-warning {
        border-top: 4px solid #f59e0b;
    }

    .border-top-danger {
        border-top: 4px solid #ef4444;
    }

    .player-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .player-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

        .player-item:last-child {
            border-bottom: none;
        }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }

    .bg-gradient-success {
        background: linear-gradient(90deg, #10b981, #34d399);
    }

    .text-success {
        color: #10b981 !important;
    }

    .text-warning {
        color: #f59e0b !important;
    }

    .text-danger {
        color: #ef4444 !important;
    }

    .text-success-dim {
        color: rgba(16, 185, 129, 0.7);
        font-size: 0.85rem;
    }

    .text-danger-dim {
        color: rgba(239, 68, 68, 0.7);
        font-size: 0.85rem;
    }
</style>

@code {
    private PartidaViewModel? partida;
    private string idPartidaTeste = "AED60E36-A9C6-4A8F-A8A5-CE82A6532700";

    protected override async Task OnInitializedAsync()
    {
        // Simulação de delay para você ver o Spinner verde funcionando em vez da tela branca
        await Task.Delay(1500);

        try
        {
            // Se der erro na API, ele carrega o Fake pra não quebrar a tela
            partida = await Http.GetFromJsonAsync<PartidaViewModel>($"api/partidas/{idPartidaTeste}");
        }
        catch
        {
            CarregarDadosFakes();
        }
    }

    private IEnumerable<PresencaViewModel> ObterConfirmados()
    {
        if (partida == null) return new List<PresencaViewModel>();
        return partida.Presencas.Where(x => x.Confirmado);
    }

    private double CalcularPorcentagem()
    {
        if (partida == null || partida.MaximoJogadores == 0) return 0;
        return (double)partida.Presencas.Count / partida.MaximoJogadores * 100;
    }

    private void CarregarDadosFakes()
    {
        partida = new PartidaViewModel
        {
            Id = Guid.NewGuid(),
            DataHora = DateTime.Now.AddDays(2).AddHours(19),
            Local = "Arena Society Center",
            MaximoJogadores = 14,
            ValorPorPessoa = 25.00m,
            Presencas = new List<PresencaViewModel>
            {
                new PresencaViewModel { Nome = "Kelvin Ribeiro", Posicao = "Meia", Confirmado = true },
                new PresencaViewModel { Nome = "Neymar Jr", Posicao = "Atacante", Confirmado = true },
                new PresencaViewModel { Nome = "Vinicius Jr", Posicao = "Ponta", Confirmado = true }
            }
        };
    }
}
