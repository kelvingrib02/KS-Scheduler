@page "/home"
@using KS.Scheduler.Frontend.Models
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Painel - KS Scheduler</PageTitle>

@if (partida == null)
{
    <div class="d-flex flex-column align-items-center justify-content-center h-100 animate-fade-in" style="min-height: 70vh;">
        <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="text-white fw-bold">Entrando em campo...</p>
    </div>
}
else
{
    <div class="container-fluid p-0 animate-up">

        <div class="card-hero mb-4 p-4 p-md-5 position-relative overflow-hidden">
            <div class="hero-bg-decoration"></div>

            <div class="row align-items-center position-relative z-index-1">
                <div class="col-lg-8 mb-4 mb-lg-0">
                    <div class="d-flex align-items-center gap-3 mb-2">
                        <span class="badge bg-success bg-opacity-20 text-white border border-success border-opacity-25 px-3 py-2 rounded-pill">
                            ⚽ Próximo Jogo
                        </span>
                        <span class="text-white-50">@partida.DataHora.ToString("dd 'de' MMMM")</span>
                    </div>

                    <h1 class="display-5 fw-bold text-white mb-2">@partida.Local</h1>

                    <div class="d-flex flex-wrap gap-4 text-gray-300 mt-3">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-clock text-primary"></i>
                            <span class="fs-5">@partida.DataHora.ToString("HH:mm")</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-geo-alt text-primary"></i>
                            <span>Campo Society 3</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-cash-stack text-primary"></i>
                            <span>R$ @partida.ValorPorPessoa.ToString("F2") / pessoa</span>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 d-flex flex-column gap-3 justify-content-end">
                    <button class="btn btn-primary-gradient w-100 py-3 d-flex align-items-center justify-content-center gap-2 shadow-lg" @onclick="CopiarLinkConvite">
                        <i class="bi bi-whatsapp fs-5"></i>
                        <span class="fw-bold">Convidar no WhatsApp</span>
                    </button>

                    <div class="d-flex gap-3">
                        <a href="https://maps.google.com/?q=@partida.Local" target="_blank" class="btn btn-outline-light flex-grow-1 py-2 d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-map"></i> Ver Mapa
                        </a>
                        <button class="btn btn-outline-light flex-grow-1 py-2 d-flex align-items-center justify-content-center gap-2">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="stat-card p-4 h-100 d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-white mb-1 text-uppercase fw-bold small">Arrecadação</p>
                            <h3 class="fw-bold text-white mb-0">R$ @CalcularArrecadado().ToString("F2")</h3>
                        </div>
                        <div class="icon-circle bg-success bg-opacity-10 text-success">
                            <i class="bi bi-currency-dollar fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="text-white-50">Meta: R$ @(partida.ValorPorPessoa* partida.MaximoJogadores)</span>
                            <span class="text-success fw-bold">@CalcularPorcentagemFinanceira()%</span>
                        </div>
                        <div class="progress bg-dark" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: @(CalcularPorcentagemFinanceira())%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="stat-card p-4 h-100 d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-white mb-1 text-uppercase fw-bold small">Jogadores</p>
                            <h3 class="fw-bold text-white mb-0">@ObterConfirmados().Count() <span class="text-white fs-6">/ @partida.MaximoJogadores</span></h3>
                        </div>
                        <div class="icon-circle bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-people-fill fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="text-white-50">Vagas restantes: @(partida.MaximoJogadores - ObterConfirmados().Count())</span>
                            <span class="text-primary fw-bold">@CalcularPorcentagemLotacao()%</span>
                        </div>
                        <div class="progress bg-dark" style="height: 6px;">
                            <div class="progress-bar bg-primary" style="width: @(CalcularPorcentagemLotacao())%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="list-container">
                    <div class="list-header border-bottom border-success border-opacity-50 pb-3 mb-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold text-white mb-0">✅ Confirmados</h5>
                        <span class="badge bg-dark border border-secondary text-white">@ObterConfirmados().Count()</span>
                    </div>

                    <div class="list-scrollable">
                        @foreach (var p in ObterConfirmados())
                        {
                            <div class="player-card mb-2 animate-in-item">
                                <div class="avatar bg-success-gradient">@p.Nome.Substring(0, 1)</div>
                                <div class="flex-grow-1 ms-3">
                                    <div class="fw-bold text-white">@p.Nome</div>
                                    <small class="text-success small">@p.Posicao</small>
                                </div>
                                @if (true)
                                {
                                    <i class="bi bi-check-circle-fill text-success" title="Pago"></i>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="list-container">
                    <div class="list-header border-bottom border-warning border-opacity-50 pb-3 mb-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold text-white mb-0">⏳ Pendentes</h5>
                        <span class="badge bg-dark border border-secondary text-white">3</span>
                    </div>

                    <div class="list-scrollable">
                        <div class="player-card mb-2 opacity-75">
                            <div class="avatar bg-warning text-dark fw-bold">?</div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold text-gray-300">Aguardando convite...</div>
                                <small class="text-white small">Link enviado há 10min</small>
                            </div>
                        </div>
                        <div class="player-card mb-2 opacity-75">
                            <div class="avatar bg-warning text-dark fw-bold">?</div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold text-gray-300">Aguardando convite...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="list-container">
                    <div class="list-header border-bottom border-danger border-opacity-50 pb-3 mb-3 d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold text-white mb-0">💸 Pagamento Pendente</h5>
                        <span class="badge bg-danger text-white">R$ 50,00</span>
                    </div>

                    <div class="list-scrollable">
                        <div class="player-card mb-2 border-start border-danger border-3">
                            <div class="avatar bg-dark text-danger border border-danger">J</div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold text-white">Jorge da Silva</div>
                                <small class="text-danger small">Pendente</small>
                            </div>
                            <div class="text-danger fw-bold">R$ 25</div>
                        </div>
                        <div class="player-card mb-2 border-start border-danger border-3">
                            <div class="avatar bg-dark text-danger border border-danger">M</div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fw-bold text-white">Marcos Paulo</div>
                                <small class="text-danger small">Pendente</small>
                            </div>
                            <div class="text-danger fw-bold">R$ 25</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
}

<style>
    .card-hero {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 24px;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
    }

    .hero-bg-decoration {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.15), transparent 40%);
        z-index: 0;
    }

    .btn-primary-gradient {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .btn-primary-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);
            color: white;
        }

    .stat-card {
        background-color: #1e293b;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .icon-circle {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .list-container {
        background-color: rgba(30, 41, 59, 0.5);
        border-radius: 20px;
        padding: 1.5rem;
        height: 100%;
        border: 1px solid rgba(255,255,255,0.02);
    }

    .player-card {
        display: flex;
        align-items: center;
        background-color: #1e293b;
        padding: 0.8rem;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        transition: transform 0.2s;
    }

        .player-card:hover {
            background-color: #253045;
            transform: translateX(4px);
        }

    .avatar {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
    }

    .bg-success-gradient {
        background: linear-gradient(135deg, #34d399 0%, #059669 100%);
    }

    .text-gray-300 {
        color: #cbd5e1;
    }

    .animate-up {
        animation: fadeInUp 0.5s ease-out;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    private PartidaViewModel? partida;
    private string idPartidaTeste = "AED60E36-A9C6-4A8F-A8A5-CE82A6532700";

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(1000);
        CarregarDadosFakes();
    }

    private IEnumerable<PresencaViewModel> ObterConfirmados() => partida?.Presencas.Where(x => x.Confirmado) ?? new List<PresencaViewModel>();

    private double CalcularPorcentagemLotacao()
    {
        if (partida == null || partida.MaximoJogadores == 0) return 0;
        return Math.Round((double)partida.Presencas.Count / partida.MaximoJogadores * 100);
    }

    private double CalcularArrecadado()
    {
        if (partida == null) return 0;
        return (double)partida.Presencas.Count(x => x.Confirmado) * (double)partida.ValorPorPessoa;
    }

    private double CalcularPorcentagemFinanceira()
    {
        if (partida == null || partida.MaximoJogadores == 0) return 0;

        var totalPossivel = partida.MaximoJogadores * partida.ValorPorPessoa; 
        var totalAtual = partida.Presencas.Count(x => x.Confirmado) * partida.ValorPorPessoa;

        if (totalPossivel == 0) return 0;

        return (double)totalAtual / (double)totalPossivel * 100;
    }

    private void CopiarLinkConvite()
    {
        
    }

    private void CarregarDadosFakes()
    {
        partida = new PartidaViewModel
        {
            Id = Guid.NewGuid(),
            DataHora = DateTime.Now.AddDays(2).AddHours(19),
            Local = "Arena Society Center - Campo 3",
            MaximoJogadores = 14,
            ValorPorPessoa = 25.00m,
            Presencas = new List<PresencaViewModel>
            {
                new PresencaViewModel { Nome = "Kelvin Ribeiro", Posicao = "Meia", Confirmado = true },
                new PresencaViewModel { Nome = "Neymar Jr", Posicao = "Atacante", Confirmado = true },
                new PresencaViewModel { Nome = "Vinicius Jr", Posicao = "Ponta", Confirmado = true },
                new PresencaViewModel { Nome = "Marquinhos", Posicao = "Zagueiro", Confirmado = true },
                new PresencaViewModel { Nome = "Alisson", Posicao = "Goleiro", Confirmado = true }
            }
        };
    }
}